<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../assets/logo/drishyam3d_logo.png" type="image/png">
    <title>Drishyam3D</title>
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">
    <!-- End CodeMirror CSS -->

    <style>
        body {
            margin: 0;
            background-color: #1a1a1a;
            color: #ddd;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #main-header {
            background-color: #252526;
            padding: 0 20px;
            height: 48px;
            display: flex;
            align-items: center;
            /* Removed justify-content: space-between; to allow h1 and menu-bar to flow naturally */
            border-bottom: 1px solid #444;
            flex-shrink: 0;
        }

        #main-header h1 {
            font-size: 1.2em;
            font-weight: 600;
            margin: 0; /* Reset margin */
            padding-right: 20px; /* Add some space after the title */
            flex-shrink: 0; /* Prevent h1 from shrinking */
        }

        #main-header .logo-img {
            height: 30px; /* Adjust height as needed */
            margin-right: 20px;
            flex-shrink: 0;
        }

        #main-header .menu-bar {
            display: flex;
            flex-grow: 0; /* Prevent menu bar from growing unnecessarily */
            flex-shrink: 0; /* Prevent menu bar from shrinking */
        }

        /* File Menu Styles */
        .menu-container {
            position: relative;
            display: inline-block;
            margin-right: 20px;
            flex-shrink: 0; /* Prevent menu containers from shrinking */
        }
        .menu-item {
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
        }
        .menu-item:hover {
            background-color: #3c3c3c;
        }
        .dropdown-content {
            top: 100%; /* Position below the menu item */
            display: none;
            position: absolute;
            background-color: #252526;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 100;
            border: 1px solid #444;
        }
        .dropdown-content a {
            color: #ddd;
            padding: 10px 14px;
            text-decoration: none;
            display: block;
            font-size: 0.9em;
        }
        .dropdown-content a.menu-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .dropdown-content a.menu-checkbox input {
            margin-right: 10px;
            cursor: pointer;
        }
        .dropdown-content a.menu-checkbox label {
            cursor: pointer;
            flex-grow: 1;
        }
        .dropdown-content a.disabled {
            color: #777;
            cursor: not-allowed;
        }
        .dropdown-content a:not(.disabled):hover { background-color: #3c3c3c; }
        .menu-container:hover .dropdown-content {
            display: block;
        }
        .menu-separator {
            height: 1px;
            margin: 5px 0;
            background-color: #444;
            border: none;
        }

        #content-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #viewport {
            flex: 1;
            display: flex;
            min-width: 0; /* Prevents flexbox overflow issues */
        }

        #editor-panel {
            display: flex;
            flex-direction: column; 
            width: 450px;
            min-width: 300px;
            max-width: 50%;
            background-color: #252526;
            resize: horizontal;
            overflow: auto;
            border-left: 1px solid #444;
        }

        #glcanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        #editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 12px;
            background-color: #3c3c3c;
            color: #cccccc;
            font-size: 0.9em;
            user-select: none;
            min-height: 35px;
        }

        #explorer-header, #editor-header-placeholder {
            padding: 0 12px;
            height: 35px;
            line-height: 35px;
            font-size: 0.8em;
            font-weight: 600;
            color: #cccccc;
            background-color: #3c3c3c;
            text-transform: uppercase;
            user-select: none;
            flex-shrink: 0;
        }

        .file-item {
            padding: 4px 20px;
            cursor: pointer;
            font-size: 0.85em;
            user-select: none;
            position: relative;
        }
        .file-item:hover {
            background-color: #3c3c3c;
        }

        .folder-item {
            padding: 6px 20px;
            cursor: pointer;
            font-weight: bold;
            user-select: none;
            color: #ccc;
            font-size: 0.85em;
        }

        .editor-tabs {
            display: flex;
            height: 100%;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            border-right: 1px solid #252526;
            background-color: #2d2d2d;
            position: relative;
        }

        .tab.active {
            background-color: #1e1e1e;
            color: #fff;
        }

        .tab.read-only {
            font-style: italic;
            color: #aaa;
        }

        .tab-close-btn {
            margin-left: 10px;
            padding: 2px 4px;
            border-radius: 4px;
            line-height: 1;
            font-family: monospace;
            font-size: 14px;
        }

        .tab-close-btn:hover {
            background-color: #555;
            color: #fff;
        }

        /* Dirty indicator styles */
        .tab .tab-close-btn {
            position: relative;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tab.dirty .tab-close-btn::before {
            content: '‚óè';
            position: absolute;
            color: #ccc;
            font-size: 12px;
        }

        #editor {
            flex: 1;
            background-color: #1e1e1e;
            display: none; /* Hide textareas by default */
            color: #eee;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 10px;
            box-sizing: border-box;
            border: none;
            resize: none; /* Resizing is now on the parent panel */
            outline: none;
        }
        
        /* CodeMirror styling overrides */
        .CodeMirror {
            flex: 1;
            display: none; /* Hide CM instances by default */
        }
        .CodeMirror.active {
            display: block; /* Show the active one */
            font-size: 14px;
            line-height: 1.5;
            height: auto; /* Let flexbox handle the height */
        }

        .CodeMirror-gutters {
            background-color: #1e1e1e !important;
            border-right: 1px solid #333 !important;
        }

        #editor-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: #3c3c3c;
            border-top: 1px solid #1e1e1e;
            flex-shrink: 0;
        }

        #reload-button {
            background-color: #0e639c;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        #reload-button:hover {
            background-color: #157dc5;
        }

        #reload-button:disabled {
            background-color: #5a5a5a;
            color: #9e9e9e;
            cursor: not-allowed;
        }

        #error-console {
            background-color: #431616;
            color: #f7a7a7;
            padding: 8px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 13px;
            display: none; /* Hidden by default */
            flex-grow: 1;
            margin-right: 12px;
        }

        #auto-refresh-container {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }

        #auto-refresh-container label {
            font-size: 13px;
            color: #ccc;
            cursor: pointer;
            user-select: none;
            margin-left: 6px;
        }

        #readonly-warning-banner {
            background-color: #ffc107; /* A warning yellow */
            color: #212529; /* Dark text for contrast */
            padding: 5px 12px;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            display: none; /* Hidden by default */
            flex-shrink: 0;
            border-top: 1px solid #444;
        }
    </style>
</head>
<body>
    <header id="main-header">
        <img src="../assets/logo/drishyam3d_logo.png" alt="Drishyam3D Logo" class="logo-img">
        <div class="menu-bar">
            <div id="file-menu-container" class="menu-container">
                <div class="menu-item">File</div>
                <div class="dropdown-content">
                    <a href="#" id="import-model-btn">Import (.zip, .gltf)...</a>
                    <div class="menu-separator"></div>
                    <a href="#" id="load-sample-gltf-btn">Load Sample Model</a>
                    <div class="menu-separator"></div>
                    <a href="#" id="reset-scene-btn">Reset Scene</a>
                </div>
            </div>
            <div id="shapes-menu-container" class="menu-container">
                <div class="menu-item">Shapes</div>
                <div class="dropdown-content">
                    <a href="#" id="shape-textured-toggle" class="menu-checkbox">
                        <input type="checkbox" id="shape-textured-checkbox">
                        <label for="shape-textured-checkbox">Textured</label>
                    </a>
                    <div class="menu-separator"></div>
                    <a href="#" id="shape-cube-btn">Cube</a>
                    <a href="#" id="shape-sphere-btn">Sphere</a>
                    <div class="menu-separator"></div>
                    <a href="#" class="disabled">Cone (soon)</a>
                    <a href="#" class="disabled">Cylinder (soon)</a>
                    <a href="#" class="disabled">Trapezoid (soon)</a>
                </div>
            </div>
            <div id="settings-menu-container" class="menu-container">
                <div class="menu-item">Settings</div>
                <div class="dropdown-content">
                    <a href="#" class="disabled">No settings available</a>
                </div>
            </div>
        </div>
        <input type="file" id="model-file-input" style="display: none;" accept=".zip,.gltf,.glb,.bin,.png,.jpg,.jpeg" multiple>
    </header>
    <main id="content-wrapper">
        <div id="explorer-panel">
            <div id="explorer-header">Explorer</div>
            <div id="explorer-list"></div>
        </div>
        <div id="viewport">
            <canvas id="glcanvas"></canvas>
        </div>
        <div id="editor-panel">
            <div id="editor-header">
                <div class="editor-tabs"></div>
            </div>
            <textarea id="vertex-editor" style="display: none;"></textarea>
            <textarea id="fragment-editor" style="display: none;"></textarea>
            <textarea id="script-editor" style="display: none;">
// The 'state' object is passed from the main application.
// 'state' contains: modelViewMatrix, projectionMatrix
// 'deltaTime' is the time in seconds since the last frame.

function init(state) {
    // This function is called once when the script is loaded.
    state.modelRotation = 0.0;
}

function update(state, deltaTime) {
    // This function is called on every frame.
    translateMatrix(state.modelViewMatrix, [-0.0, 0.0, -6.0]);
    rotateMatrix(state.modelViewMatrix, state.modelRotation, [0, 1, 0]);
    state.modelRotation += deltaTime * 0.5;
}
            </textarea>
            <!-- Engine Scripts (Read-Only) -->
            <textarea id="main-editor" style="display: none;">
import {
    translateMatrix,
    rotateMatrix
} from './matrix.js';
import { initShaderProgram } from './webgl-helpers.js';
import { setupEditors } from './editor.js';
import { setupExplorer } from './explorer.js';
import { createScene } from './scene.js';

window.onload = function() {
    // ... (main.js content)
};
            </textarea>
            <textarea id="scene-editor" style="display: none;">
import { createIdentityMatrix, createPerspectiveMatrix } from './matrix.js';
import { initCubeBuffers } from './geometry.js';

function resizeCanvas(canvas) {
    // ... (scene.js content)
}

export function createScene(gl, canvas) {
    // ... (scene.js content)
}
            </textarea>
            <textarea id="editor-editor" style="display: none;">
/**
 * Initializes the CodeMirror editors and sets up UI event listeners.
 * @param {function} onRun - The callback function to execute when the "Run" button is clicked.
 */
export function setupEditors(onRun) {
    // ... (editor.js content)
}
            </textarea>
            <textarea id="explorer-editor" style="display: none;">
const projectFiles = [
    // ... (explorer.js content)
];

const engineFiles = [
    // ... (explorer.js content)
];

/**
 * Sets up the file explorer panel.
 * @param {function(fileId, fileName, fileType, readOnly, path): void} onFileOpen - Callback to run when a file is double-clicked.
 */
export function setupExplorer(onFileOpen) {
    // ... (explorer.js content)
}
            </textarea>
            <div id="readonly-warning-banner">&#9888; This file is read-only.</div>
            <div id="editor-footer">
                <div id="error-console"></div>
                <div id="auto-refresh-container" title="When enabled, the viewport will automatically refresh 10 seconds after you stop typing.">
                    <input type="checkbox" id="auto-refresh-checkbox">
                    <label for="auto-refresh-checkbox">Auto Refresh</label>
                </div>
                <button id="reload-button">Run</button>
            </div>
        </div>
    </main>
    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.min.js"></script>
    <!-- End CodeMirror JS -->

    <!-- GLTF Loader -->

    <!-- JSZip for handling .zip file imports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script id="main-script" type="module"></script>

    <!--
      Runtime base resolver:
      - Locally (dev) it resolves to relative ../ paths when mainpage.html is inside html/
      - On GitHub Pages (username.github.io/repo) it resolves to "/<repo>/..."
      This avoids hardcoding repo paths and keeps local testing intact.
    -->
    <script>
    (function () {
        // NOTE: update repoPrefix only if you move/rename the repo
        const repoPrefix = '/Drishyam3D';
        const hostname = location.hostname || '';
        const isGithubPages = hostname.endsWith('.github.io');
        // Expose helper for resolver; other scripts can call this
        window.__DRISHYAM_ASSET = function (p) {
            // Accept both leading-slash and no-leading-slash inputs
            if (!p) return p;
            if (p.startsWith('/')) p = p.slice(1);
            if (isGithubPages) {
                return repoPrefix + '/' + p;
            }
            // Local/dev: if the page is under /html/ (html/mainpage.html) then assets are one level up
            return '../' + p;
        };
        // Dynamically set the src for the main script module
        document.getElementById('main-script').src = window.__DRISHYAM_ASSET('scripts/main.js');
    })();
    </script>
</body>
</html>
